<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trắc Nghiệm</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .correct-answer {
        background-color: rgb(134, 239, 172);
        color: #000;
      }
      .wrong-answer {
        background-color: rgb(252, 165, 165);
        color: #000;
      }
      .selected {
        background-color: rgb(191, 219, 254);
      }
    </style>
  </head>

  <body>
    <div
      class="w-full min-h-screen flex items-center justify-center bg-gray-50 p-4"
    >
      <div>
        <!-- Câu hỏi chính -->
        <div
          class="w-[360px] sm:w-[450px] md:w-[700px] bg-white border rounded-lg shadow-md p-6"
        >
          <div class="flex justify-between items-center mb-4">
            <div
              class="px-3 py-1 border rounded bg-blue-50 font-medium"
              id="count"
            ></div>
            <div
              class="px-3 py-1 border rounded bg-green-50 font-medium"
              id="point"
            ></div>
          </div>

          <div id="text-question" class="text-lg font-medium mb-6"></div>

          <div class="space-y-2">
            <div
              class="w-full border-2 p-3 rounded-md cursor-pointer transition"
              id="input-1"
            >
              <label class="cursor-pointer" id="answer-1"></label>
            </div>
            <div
              class="w-full border-2 p-3 rounded-md cursor-pointer transition"
              id="input-2"
            >
              <label class="cursor-pointer" id="answer-2"></label>
            </div>
            <div
              class="w-full border-2 p-3 rounded-md cursor-pointer transition"
              id="input-3"
            >
              <label class="cursor-pointer" id="answer-3"></label>
            </div>
            <div
              class="w-full border-2 p-3 rounded-md cursor-pointer transition"
              id="input-4"
            >
              <label class="cursor-pointer" id="answer-4"></label>
            </div>
          </div>

          <div class="mt-6 flex justify-between items-center">
            <div id="text-answer" class="font-medium text-green-600"></div>
            <button
              class="bg-blue-500 hover:bg-blue-600 rounded-md py-2 px-4 text-white font-medium transition"
              id="button-next"
            >
              Câu tiếp theo
            </button>
          </div>
        </div>

        <!-- Danh sách câu sai -->
        <div
          class="w-[360px] sm:w-[450px] md:w-[700px] bg-white border rounded-lg shadow-md p-6 mt-4"
        >
          <div class="flex justify-between items-center">
            <button
              id="btn-show-failed"
              class="px-4 py-2 bg-rose-500 hover:bg-rose-600 rounded-md text-white font-medium transition"
            >
              Hiển thị câu sai (<span id="failed-count">0</span>)
            </button>
            <button
              id="btn-hide-failed"
              class="px-4 py-2 bg-gray-500 hover:bg-gray-600 rounded-md text-white font-medium transition"
            >
              Ẩn bỏ
            </button>
          </div>
          <div
            class="space-y-3 mt-4"
            id="listFaild"
            style="display: none"
          ></div>
        </div>
      </div>
    </div>

    <script type="module">
      // Import từ 2 file JS
      import { questions1 } from "./questions1.js";
      import { questions2 } from "./questions2.js";

      const textQuestion = document.querySelector("#text-question");
      const count = document.querySelector("#count");
      const point = document.querySelector("#point");
      const answerElements = [
        document.querySelector("#answer-1"),
        document.querySelector("#answer-2"),
        document.querySelector("#answer-3"),
        document.querySelector("#answer-4"),
      ];
      const inputElements = [
        document.querySelector("#input-1"),
        document.querySelector("#input-2"),
        document.querySelector("#input-3"),
        document.querySelector("#input-4"),
      ];
      const textAnswer = document.querySelector("#text-answer");
      const button = document.querySelector("#button-next");
      const listFaild = document.querySelector("#listFaild");
      const failedCountElement = document.querySelector("#failed-count");
      const btnShowFailed = document.querySelector("#btn-show-failed");
      const btnHideFailed = document.querySelector("#btn-hide-failed");

      function removeDuplicateQuestions(questions) {
        const seen = new Map();
        const uniqueQuestions = [];

        questions.forEach((q) => {
          // Chuẩn hóa answer về string để so sánh
          const answerStr = Array.isArray(q.answer) ? q.answer[0] : q.answer;
          const key = `${q.title}|||${answerStr}`;

          if (!seen.has(key)) {
            seen.set(key, true);
            uniqueQuestions.push(q);
          } else {
            console.log("Đã loại bỏ câu trùng lặp:", q);
          }
        });

        return uniqueQuestions;
      }

      // Gộp và xáo trộn câu hỏi
      const listQuestion = removeDuplicateQuestions([
        ...questions1,
        ...questions2,
      ]);

      function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
      }

      const shuffledQuestions = shuffleArray(listQuestion);

      let questionIndex = 0;
      let countPoint = 0;
      let isAnswered = false;
      let listQuestionFaild = [];

      function showFailedQuestions() {
        if (listQuestionFaild.length === 0) {
          listFaild.innerHTML =
            '<p class="text-gray-500 text-center">Chưa có câu sai nào</p>';
        } else {
          const listHtml = listQuestionFaild
            .map((item, i) => {
              const correctIndex = item.options.indexOf(item.answer[0]);
              return `<div class="w-full border-2 border-rose-300 p-4 rounded-lg bg-rose-50">
                <div class="font-medium mb-3">
                  Câu ${i + 1}: ${item.title}
                </div>
                <div class="space-y-2">
                  ${item.options
                    .map(
                      (opt, idx) => `
                    <div class="w-full border p-2 rounded ${
                      idx === correctIndex
                        ? "bg-green-100 border-green-400 font-medium"
                        : ""
                    }">
                      ${opt}
                    </div>
                  `
                    )
                    .join("")}
                </div>
                <div class="mt-3 font-medium text-green-700">
                  ✓ Đáp án đúng: ${item.answer[0]}
                </div>
              </div>`;
            })
            .join("");
          listFaild.innerHTML = listHtml;
        }
        listFaild.style.display = "block";
      }

      function hideFailedQuestions() {
        listFaild.style.display = "none";
      }

      function displayQuestion() {
        const currentQuestion = shuffledQuestions[questionIndex];
        textQuestion.innerHTML = currentQuestion.title;

        answerElements.forEach((el, idx) => {
          el.innerHTML = currentQuestion.options[idx];
        });

        count.textContent = `${questionIndex + 1} / ${
          shuffledQuestions.length
        }`;
        point.textContent = `Đúng: ${countPoint}/${
          questionIndex > 0 ? questionIndex : 0
        }`;

        // Reset màu sắc
        inputElements.forEach((el) => {
          el.className =
            "w-full border-2 p-3 rounded-md cursor-pointer  transition";
        });

        textAnswer.textContent = "";
        isAnswered = false;
      }

      function checkAnswer(selectedIndex) {
        const currentQuestion = shuffledQuestions[questionIndex];
        const selectedAnswer = currentQuestion.options[selectedIndex];

        // Xử lý cả 2 trường hợp: answer là array hoặc string
        const correctAnswer = Array.isArray(currentQuestion.answer)
          ? currentQuestion.answer[0]
          : currentQuestion.answer;

        const correctIndex = currentQuestion.options.indexOf(correctAnswer);

        // Kiểm tra xem có tìm thấy đáp án đúng không
        if (correctIndex === -1) {
          console.error(
            "Không tìm thấy đáp án đúng trong options:",
            currentQuestion
          );
          textAnswer.textContent = `⚠ Lỗi: Đáp án không hợp lệ: ${correctAnswer}`;
          textAnswer.className = "font-medium text-orange-600";
          return;
        }

        if (selectedAnswer === correctAnswer) {
          countPoint++;
          inputElements[selectedIndex].classList.add("correct-answer");
          textAnswer.textContent = `✓ Chính xác!`;
          textAnswer.className = "font-medium text-green-600";
        } else {
          inputElements[selectedIndex].classList.add("wrong-answer");
          inputElements[correctIndex].classList.add("correct-answer");
          textAnswer.textContent = `✗ Sai! Đáp án đúng: ${correctAnswer}`;
          textAnswer.className = "font-medium text-rose-600";

          // Thêm vào danh sách câu sai (chuẩn hóa answer thành array)
          const normalizedQuestion = {
            ...currentQuestion,
            answer: Array.isArray(currentQuestion.answer)
              ? currentQuestion.answer
              : [currentQuestion.answer],
          };

          listQuestionFaild.push(normalizedQuestion);
          failedCountElement.textContent = listQuestionFaild.length;
        }

        point.textContent = `Đúng: ${countPoint}/${questionIndex + 1}`;
      }

      function onAnswer(value) {
        if (isAnswered) return;

        checkAnswer(value);
        isAnswered = true;

        // Vô hiệu hóa các lựa chọn khác
        inputElements.forEach((el) => {
          el.style.cursor = "default";
        });
      }

      // Gán sự kiện click cho các đáp án
      inputElements.forEach((el, index) => {
        el.addEventListener("click", () => onAnswer(index));
      });

      // Gán sự kiện cho các nút
      btnShowFailed.addEventListener("click", showFailedQuestions);
      btnHideFailed.addEventListener("click", hideFailedQuestions);

      button.addEventListener("click", function () {
        if (!isAnswered) {
          alert("Vui lòng chọn đáp án trước khi chuyển câu!");
          return;
        }

        if (questionIndex === shuffledQuestions.length - 1) {
          const percentage = (
            (countPoint / shuffledQuestions.length) *
            100
          ).toFixed(1);
          alert(
            `Hoàn thành! Kết quả: ${countPoint}/${shuffledQuestions.length} (${percentage}%)`
          );
          return;
        }

        questionIndex++;
        displayQuestion();

        // Kích hoạt lại các lựa chọn
        inputElements.forEach((el) => {
          el.style.cursor = "pointer";
        });
      });

      // Khởi tạo câu hỏi đầu tiên
      displayQuestion();
    </script>
  </body>
</html>
